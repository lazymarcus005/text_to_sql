# agentic_ai_system/validators/domain_guard.py
from __future__ import annotations
from dataclasses import dataclass
from typing import List, Tuple
import re


@dataclass(frozen=True)
class DomainGuardResult:
    allowed: bool
    message: str
    matched_keywords: List[str]


# ‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: 
_KEYWORD_GROUPS: List[List[str]] = [
    [
        "disaster", "emergency", "catastrophe",
        "flood", "flooding", "storm", "typhoon", "cyclone",
        "earthquake", "landslide", "drought", "fire", "wildfire",
        "‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", "‡πÄ‡∏´‡∏ï‡∏∏‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", "‡πÄ‡∏´‡∏ï‡∏∏‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô",
        "‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°", "‡∏≠‡∏∏‡∏ó‡∏Å‡∏†‡∏±‡∏¢", "‡∏û‡∏≤‡∏¢‡∏∏", "‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß", "‡∏î‡∏¥‡∏ô‡∏ñ‡∏•‡πà‡∏°",
        "‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ", "‡πÑ‡∏ü‡∏õ‡πà‡∏≤", "‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏á",
    ],    
    [
        "apply", "application", "request", "submit",
        "register", "registration", "form", "document",
        "‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠", "‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏Ñ‡∏≥‡∏Ç‡∏≠", 
        "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô", "‡∏™‡∏°‡∏±‡∏Ñ‡∏£", "‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á", "‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠",
        "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", "‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô", "‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£"
    ],
    [
        "assistance", "aid", "relief", "support", "benefit",
        "grant", "compensation", "payment",
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
        "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏µ‡∏¢‡∏ß‡∏¢‡∏≤", "‡πÄ‡∏á‡∏¥‡∏ô‡∏ä‡∏î‡πÄ‡∏ä‡∏¢", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå",
        "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥", "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå", "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£", "‡∏™‡∏±‡∏ï‡∏ß‡πå"
    ],
    [
        "status", "tracking", "progress", "review", "approve", "approved",
        "reject", "rejected", "pending",
        "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠", "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
        "‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤", "‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß",
        "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô", "‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò", "‡∏£‡∏≠‡∏ú‡∏•",
    ],
    [
        "government", "authority", "department", "office",
        "agency", "local authority",
        "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê", "‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£",
        "‡∏Å‡∏£‡∏°", "‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á", "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
        "‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô", "‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•", "‡∏≠‡∏ö‡∏ï",
    ],
    # sales / revenue / metrics
    [
        "victim", "affected", "household", "family",
        "damage", "loss", "property damage",
        "‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢", "‡∏ú‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö",
        "‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô", "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß",
        "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", "‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢", "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢",
    ],
    # time/filter (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° metric ‡∏ú‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
    [
        "today", "yesterday", "this week", "last week", "this month", "last month",
        "this year", "last year", "date", "time", "range", "between",
        "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô", "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ", "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ", "‡∏õ‡∏µ‡∏ô‡∏µ‡πâ", "‡∏ä‡πà‡∏ß‡∏á", "‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
    ],
]

# ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≥‡∏°‡∏±‡∏ô‡∏™‡∏±‡πâ‡∏ô/‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏•‡∏¢‡πÉ‡∏™‡πà‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ï‡πâ‡∏≠‡∏á match ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏ï‡πá‡∏°‚Äù ‡∏•‡∏î false positive
_STRICT_WORDS = {
    "aid", "grant", "form", "status", "apply",
    "‡∏™‡∏¥‡∏ó‡∏ò‡∏¥", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠", "‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á",
}

def _normalize(text: str) -> str:
    text = (text or "").strip().lower()
    # ‡∏•‡∏î noise
    text = re.sub(r"\s+", " ", text)
    return text


def _match_keyword(q: str, kw: str) -> bool:
    if kw in _STRICT_WORDS:
        # match ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥ (word boundary) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
        return re.search(rf"\b{re.escape(kw)}\b", q) is not None
    # ‡πÑ‡∏ó‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ word boundary ‡∏ä‡∏±‡∏î ‡πÄ‡∏•‡∏¢‡πÉ‡∏ä‡πâ contains ‡πÑ‡∏î‡πâ
    return kw in q


def check_in_domain(user_prompt: str) -> DomainGuardResult:
    """
    ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö: ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ / ‡∏™‡∏≤‡∏Ç‡∏≤ / ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢-‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ
    ‡∏ñ‡πâ‡∏≤‡∏ô‡∏≠‡∏Å‡πÇ‡∏î‡πÄ‡∏°‡∏ô -> allowed=False ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö
    """
    q = _normalize(user_prompt)

    matched: List[str] = []
    for group in _KEYWORD_GROUPS:
        for kw in group:
            if _match_keyword(q, kw):
                matched.append(kw)

    # ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏á‡πà‡∏≤‡∏¢‡πÜ: ‡∏°‡∏µ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≥ -> ‡∏ú‡πà‡∏≤‡∏ô
    if matched:
        return DomainGuardResult(
            allowed=True,
            message="",
            matched_keywords=sorted(set(matched)),
        )

    # ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô -> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò + ‡∏ä‡∏µ‡πâ‡∏ó‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏î‡πÄ‡∏°‡∏ô
    msg = (
        "### ‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üôè\n"
        "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö **‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡πà‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô\n"
        "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö\n\n"
        "#### ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö:\n"
        "- ‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á\n"
        "- ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á\n"
        "- ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏†‡∏±‡∏¢‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏î\n"
        "- ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢\n"
    )

    return DomainGuardResult(allowed=False, message=msg, matched_keywords=[])
